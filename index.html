<!doctype html>
<html lang="lt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spinta â†’ Deriniai (MVP)</title>
  <meta name="theme-color" content="#0b0b10">
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" href="./icons/icon-192.png">
  <style>
    :root{ --bg:#0b0b10; --card:#14141d; --muted:#7a7a8c; --text:#eaeaf2; --accent:#ff2a6d; --line:#222230; }
    *{box-sizing:border-box}
    body{margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial; background:linear-gradient(180deg,#0b0b10,#12121a 60%,#0b0b10); color:var(--text)}
    header{position:sticky; top:0; backdrop-filter:saturate(160%) blur(8px); background:rgba(10,10,16,.6); border-bottom:1px solid var(--line); z-index:10}
    header .wrap{display:flex; gap:16px; align-items:center; padding:14px 18px; max-width:1100px; margin:0 auto}
    .brand{font-weight:700; letter-spacing:.3px}
    .pill{border:1px solid var(--line); padding:6px 10px; border-radius:999px; color:var(--muted); font-size:12px}
    .install{margin-left:auto}
    main{max-width:1100px; margin:24px auto; padding:0 18px;}
    .grid{display:grid; grid-template-columns:1.1fr .9fr; gap:18px}
    @media (max-width:950px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card); border:1px solid var(--line); border-radius:16px; padding:16px; box-shadow:0 8px 26px rgba(0,0,0,.25)}
    h2{margin:0 0 12px 0; font-size:18px}
    label{font-size:12px; color:var(--muted)}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .row > *{flex:1}
    input[type="file"]{padding:10px; background:#0f0f16; border:1px dashed #2a2a3a; border-radius:12px; color:var(--muted)}
    select, input[type="text"], input[type="number"], button, input[type="range"]{background:#0f0f16; border:1px solid #26263a; color:var(--text); padding:10px 12px; border-radius:12px}
    button{cursor:pointer; font-weight:600}
    button.primary{background:linear-gradient(135deg,#ff2a6d,#ff6a3d); border:none}
    button.ghost{background:transparent; border:1px solid #33334a}
    .wardrobe{display:grid; grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); gap:12px}
    .item{background:#0f0f16; border:1px solid #2a2a3a; border-radius:14px; overflow:hidden}
    .item .imgwrap{aspect-ratio:1/1; background:#0a0a12; display:grid; place-items:center}
    .item img{max-width:100%; max-height:100%; display:block; object-fit:contain}
    .item .meta{padding:10px; display:flex; align-items:center; justify-content:space-between; gap:8px}
    .chip{font-size:11px; color:#cfcfe6; padding:4px 8px; border-radius:999px; border:1px solid #3a3a55}
    .swatches{display:flex; gap:6px; align-items:center}
    .sw{width:14px; height:14px; border-radius:4px; border:1px solid #0006}
    .outfits{display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:14px}
    .outfit{background:#0f0f16; border:1px solid #2a2a3a; border-radius:16px; padding:12px; display:flex; flex-direction:column; gap:10px}
    .canvaswrap{background:conic-gradient(from 180deg at 50% 20%, #111018, #0b0b12 40%, #121224); border:1px solid #22223a; border-radius:12px; display:grid; place-items:center; aspect-ratio:3/4}
    .muted{color:var(--muted); font-size:12px}
    .controls{display:flex; gap:8px; flex-wrap:wrap}
    .badge{font-size:11px; color:#fff; background:#2e2e4a; border:1px solid #444468; padding:4px 8px; border-radius:999px}
    footer{opacity:.8; color:var(--muted); text-align:center; padding:24px}
    .tools{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">ğŸ‘— Spinta â†’ Deriniai (MVP)</div>
      <div class="pill">PWA + IÅ¡saugojimas + <b>Daugiapalviai rÅ«bai</b></div>
      <button id="installBtn" class="chip install" style="display:none">ğŸ“¥ Ä®sidiegti programÄ—lÄ™</button>
    </div>
  </header>

  <main>
    <div class="grid">
      <section class="card">
        <h2>1) PridÄ—k rÅ«bÄ…</h2>
        <div class="row">
          <div>
            <label>Nuotrauka (PNG/JPG)</label>
            <input id="file" type="file" accept="image/*" />
            <div class="muted">PaletÄ— skaiÄiuojama centre (k-means), parodys iki 3 spalvÅ³.</div>
          </div>
          <div>
            <label>Kategorija</label>
            <select id="cat">
              <option>VirÅ¡us</option>
              <option>ApaÄia</option>
              <option>SuknelÄ—</option>
              <option>VirÅ¡utiniai</option>
              <option>Batai</option>
              <option>Aksesuaras</option>
            </select>
          </div>
          <div>
            <label>Stilius</label>
            <select id="style">
              <option value="basic">Basic</option>
              <option value="smart">Smart</option>
              <option value="bold">DrÄ…sus</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div>
            <label>Pastaba (nebÅ«tina)</label>
            <input id="note" type="text" placeholder="pvz., raÅ¡tuota suknelÄ—" />
          </div>
          <div>
            <label>Å½yma</label>
            <input id="tag" type="text" placeholder="#gameon, #vakaras" />
          </div>
          <div style="flex:0 0 auto; align-self:end">
            <button class="primary" id="addBtn">â• Ä®kelti</button>
          </div>
        </div>

        <div class="tools">
          <button class="ghost" id="exportBtn">ğŸ’¾ Eksportuoti spintÄ… (JSON)</button>
          <label class="chip" style="cursor:pointer">
            ğŸ“¥ Importuoti
            <input id="importFile" type="file" accept="application/json" style="display:none">
          </label>
          <button class="ghost" id="clearWardrobe">ğŸ—‘ï¸ IÅ¡valyti spintÄ…</button>
        </div>
        <div class="muted">Auto iÅ¡saugojimas vietoje (narÅ¡yklÄ—je). Eksportas leidÅ¾ia persikelti Ä¯ kitÄ… Ä¯renginÄ¯.</div>
      </section>

      <section class="card">
        <h2>2) DeriniÅ³ nustatymai</h2>
        <div class="row">
          <div>
            <label>DeriniÅ³ kiekis</label>
            <input id="count" type="number" min="1" max="20" value="6" />
          </div>
          <div>
            <label>DrÄ…sos lygis</label>
            <input id="boldness" type="range" min="0" max="100" value="30" />
            <div class="muted">0 â€“ saugiau, 100 â€“ drÄ…siau</div>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="controls">
            <button class="primary" id="genBtn">âœ¨ Generuoti derinius</button>
            <button class="ghost" id="clearOutfits">ğŸ—‘ï¸ IÅ¡valyti derinius</button>
          </div>
          <div class="badge">SpalvÅ³ harmonijos + paletÄ—s</div>
        </div>
      </section>
    </div>

    <section class="card" style="margin-top:18px">
      <h2>3) Tavo spinta</h2>
      <div id="wardrobe" class="wardrobe"></div>
      <div class="muted" id="emptyMsg">Dar nÄ—ra Ä¯keltÅ³ rÅ«bÅ³. Ä®kelk bent 3â€“4 (virÅ¡us/apaÄia/batai arba suknelÄ—/batai).</div>
    </section>

    <section class="card" style="margin-top:18px">
      <h2>4) Sugeneruoti deriniai</h2>
      <div id="outfits" class="outfits"></div>
    </section>

  </main>

  <footer>
    <div>Duomenys saugomi <b>tik tavo Ä¯renginyje</b>. Jei diegimo mygtuko nematai â€“ atnaujink puslapÄ¯ arba pervadink `CACHE` service workeryje.</div>
  </footer>

<script>
// --- PWA Install ---
let deferredPrompt = null;
const installBtn = document.getElementById("installBtn");
window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault(); deferredPrompt = e; installBtn.style.display = "inline-flex";
});
installBtn?.addEventListener("click", async () => {
  if (!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice;
  deferredPrompt = null; installBtn.style.display = "none";
});
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => navigator.serviceWorker.register("./service-worker.js").catch(console.error));
}

// --- App state & storage ---
const $ = (s)=>document.querySelector(s);
let wardrobe = [];
const KEY = "wardrobe_palette_v1";
function saveWardrobe(){ try{ localStorage.setItem(KEY, JSON.stringify(wardrobe)); }catch(e){} }
function loadWardrobe(){ try{ wardrobe = JSON.parse(localStorage.getItem(KEY) || "[]"); }catch(e){ wardrobe = []; } }

// --- Color + palette helpers ---
const rand = (n)=>Math.floor(Math.random()*n);
function rgbToHsl(r,g,b){r/=255;g/=255;b/=255;const max=Math.max(r,g,b),min=Math.min(r,g,b);let h,s,l=(max+min)/2;if(max===min){h=s=0;}else{const d=max-min;s=l>0.5?d/(2-max-min):d/(max+min);switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break;}h/=6;}return [h*360,s,l]}
function hex(c){return '#'+c.map(v=>('0'+v.toString(16)).slice(-2)).join('')}
function kmeans(pixels, k=5, iters=8){
  const centers = []; const used = new Set();
  while(centers.length < k && centers.length < pixels.length){
    const idx = Math.floor(Math.random()*pixels.length);
    if(!used.has(idx)){ used.add(idx); centers.push(pixels[idx].slice()); }
  }
  for(let t=0;t<iters;t++){
    const groups = Array.from({length:k}, ()=>({sum:[0,0,0], n:0}));
    for(const p of pixels){
      let best=0, bd=1e9;
      for(let i=0;i<centers.length;i++){
        const c=centers[i]; const d=(p[0]-c[0])**2+(p[1]-c[1])**2+(p[2]-c[2])**2;
        if(d<bd){bd=d; best=i;}
      }
      groups[best].sum[0]+=p[0]; groups[best].sum[1]+=p[1]; groups[best].sum[2]+=p[2]; groups[best].n++;
    }
    for(let i=0;i<centers.length;i++){
      if(groups[i].n>0){
        centers[i][0]=groups[i].sum[0]/groups[i].n;
        centers[i][1]=groups[i].sum[1]/groups[i].n;
        centers[i][2]=groups[i].sum[2]/groups[i].n;
      }
    }
  }
  const counts = Array(centers.length).fill(0);
  for(const p of pixels){
    let best=0, bd=1e9;
    for(let i=0;i<centers.length;i++){
      const c=centers[i]; const d=(p[0]-c[0])**2+(p[1]-c[1])**2+(p[2]-c[2])**2;
      if(d<bd){bd=d; best=i;}
    }
    counts[best]++;
  }
  return centers.map((c,i)=>({rgb:c, count:counts[i]}));
}

function extractPalette(img, want=3){
  const cvs=document.createElement('canvas'); const ctx=cvs.getContext('2d');
  const w=img.naturalWidth, h=img.naturalHeight;
  const S=240; const r=Math.min(1, S/Math.max(w,h));
  cvs.width=w*r; cvs.height=h*r; ctx.drawImage(img,0,0,cvs.width,cvs.height);
  const cx=Math.floor(cvs.width*0.2), cy=Math.floor(cvs.height*0.2);
  const cw=Math.floor(cvs.width*0.6), ch=Math.floor(cvs.height*0.6);
  const data=ctx.getImageData(cx,cy,cw,ch).data;
  const pix=[];
  for(let i=0;i<data.length;i+=4*4){
    const a=data[i+3]; if(a<200) continue;
    const r=data[i], g=data[i+1], b=data[i+2];
    const [H,Sv,L]=rgbToHsl(r,g,b);
    // atmesk labai baltÄ… pilkÄ… fonÄ…
    if(L>0.92 && Sv<0.18) continue;
    pix.push([r,g,b]);
  }
  if(!pix.length){
    const rgb=[90,90,90]; return [{rgb, hex:hex(rgb), hsl:rgbToHsl(...rgb), count:1}];
  }
  const clusters=kmeans(pix, 5, 8).map(c=>{
    const rgb=c.rgb.map(x=>Math.round(x));
    return {rgb, hex:hex(rgb), hsl:rgbToHsl(rgb[0],rgb[1],rgb[2]), count:c.count};
  });
  // reitingas: dydis + sodrumas (pirmenybÄ— spalvai, ne fonui) + tamsumas truputÄ¯
  clusters.forEach(c=>{ c.score=c.count*(0.8 + c.hsl[1]*0.4 + (1-c.hsl[2])*0.15); });
  clusters.sort((a,b)=>b.score-a.score);
  // paimkim iki 3 skirtingÅ³ pagal atstumÄ… tarp atspalviÅ³
  const res=[];
  for(const c of clusters){
    const ok = res.every(r=> Math.min(Math.abs(r.hsl[0]-c.hsl[0]), 360-Math.abs(r.hsl[0]-c.hsl[0])) > 18);
    if(ok) res.push(c);
    if(res.length>=want) break;
  }
  if(!res.length) res.push(clusters[0]);
  return res;
}

// --- Wardrobe ---
function loadImage(src){ return new Promise((resolve,reject)=>{ const img=new Image(); img.onload=()=>resolve(img); img.onerror=reject; img.src=src; }); }
function addItem({src,cat,style,note,tag}){
  loadImage(src).then(img=>{
    const palette=extractPalette(img,3);
    const item={id:crypto.randomUUID(), src, cat, style, note, tag, palette, color:palette[0]};
    wardrobe.push(item); saveWardrobe(); renderWardrobe();
  });
}
function renderWardrobe(){
  const list=$('#wardrobe'); list.innerHTML='';
  if(!wardrobe.length){ $('#emptyMsg').style.display='block'; return } else { $('#emptyMsg').style.display='none' }
  wardrobe.forEach(it=>{
    const card=document.createElement('div'); card.className='item';
    const top=document.createElement('div'); top.className='imgwrap'; const img=new Image(); img.src=it.src; top.appendChild(img);
    const meta=document.createElement('div'); meta.className='meta';
    const left=document.createElement('div'); left.innerHTML=`<div class="chip">${it.cat}</div>`; 
    const right=document.createElement('div'); right.className='swatches';
    it.palette.slice(0,3).forEach(p=>{ const d=document.createElement('div'); d.className='sw'; d.style.background=p.hex; right.appendChild(d); });
    const style=document.createElement('div'); style.className='chip'; style.textContent=it.style; right.appendChild(style);
    meta.appendChild(left); meta.appendChild(right);
    card.appendChild(top); card.appendChild(meta);
    list.appendChild(card);
  })
}

// --- Outfits ---
function pick(arr,filterFn){const a=filterFn?arr.filter(filterFn):arr; return a.length? a[rand(a.length)]:null}
function hueDist(h1,h2){let d=Math.abs(h1-h2); return Math.min(d,360-d)}
function pairHarmony(huesA,huesB){
  // max suderinamumas tarp paletÄ—s atspalviÅ³ (analoginis arba komplementarus)
  let best=0;
  for(const ha of huesA) for(const hb of huesB){
    const d=hueDist(ha,hb);
    const analog= Math.exp(-Math.pow(d-30,2)/ (2*20*20));
    const comp  = Math.exp(-Math.pow(d-180,2)/(2*25*25));
    best = Math.max(best, analog*0.9 + comp*1.1);
  }
  return best;
}
function scoreCombo(items,boldness){
  let score=0;
  // naudok po 2 atspalvius iÅ¡ kiekvieno rÅ«bo (jei yra)
  const palHues = items.map(it=> it.palette.slice(0,2).map(p=>p.hsl[0]));
  for(let i=0;i<palHues.length;i++) for(let j=i+1;j<palHues.length;j++){
    score += pairHarmony(palHues[i], palHues[j]);
  }
  // premija multi-spalviams itemams (paletÄ—s Ä¯vairovÄ—)
  const diversity = items.map(it=> it.palette.length>=2 ? 0.2 : 0).reduce((a,b)=>a+b,0);
  score += diversity;
  const boldCount=items.filter(i=>i.style==='bold').length; const smartCount=items.filter(i=>i.style==='smart').length;
  score += (boldCount * (boldness/50)) + smartCount*0.3;
  return score;
}
function generateOutfits(n,boldness){
  const tops=wardrobe.filter(i=>i.cat==='VirÅ¡us');
  const bottoms=wardrobe.filter(i=>i.cat==='ApaÄia');
  const dresses=wardrobe.filter(i=>i.cat==='SuknelÄ—');
  const outers=wardrobe.filter(i=>i.cat==='VirÅ¡utiniai');
  const shoes=wardrobe.filter(i=>i.cat==='Batai');
  const result=[]; const tries=2000;
  for(let k=0;k<tries && result.length<n; k++){
    const useDress = dresses.length && Math.random()<0.35;
    let combo=[];
    if(useDress){
      const d=pick(dresses); const sh=pick(shoes); if(!d||!sh) continue; combo=[d,sh]; const o = Math.random()<0.5?pick(outers):null; if(o) combo.push(o);
    }else{
      const t=pick(tops), b=pick(bottoms), sh=pick(shoes); if(!t||!b||!sh) continue; combo=[t,b,sh]; const o=Math.random()<0.4?pick(outers):null; if(o) combo.push(o);
    }
    const sc=scoreCombo(combo,boldness);
    result.push({items:combo, score:sc});
    result.sort((a,b)=>b.score-a.score);
    if(result.length>n) result.pop();
  }
  return result;
}

function roundRect(ctx, x, y, w, h, r, fill, stroke){
  if (w<2*r) r=w/2; if (h<2*r) r=h/2; ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); if(fill) ctx.fill(); if(stroke) ctx.stroke();
}
function loadImage(src){ return new Promise((resolve,reject)=>{ const img=new Image(); img.onload=()=>resolve(img); img.onerror=reject; img.src=src; }); }
async function renderOutfitToCanvas(outfit, canvas){
  const ctx=canvas.getContext('2d'); const width=canvas.width=600, height=800;
  const grad=ctx.createLinearGradient(0,0,0,height); grad.addColorStop(0,'#0f0f16'); grad.addColorStop(1,'#0b0b12'); ctx.fillStyle=grad; ctx.fillRect(0,0,width,height);
  ctx.fillStyle='rgba(255,255,255,.08)'; roundRect(ctx,16,16,150,28,12,true,false);
  ctx.fillStyle='#eaeaf2'; ctx.font='12px Inter, system-ui'; ctx.fillText('Outfit', 26, 34);
  const slots=outfit.items.length; const pad=22; const areaH=height-80; const boxH=Math.min(260, (areaH - pad*(slots-1))/slots);
  let y=60; const imgs = await Promise.all(outfit.items.map(it=>loadImage(it.src)));
  for(let idx=0; idx<imgs.length; idx++){
    const it = outfit.items[idx]; const img = imgs[idx];
    const ratio = Math.min((width-2*pad)/img.naturalWidth, boxH/img.naturalHeight);
    const w=img.naturalWidth*ratio, h=img.naturalHeight*ratio; const x=(width-w)/2;
    ctx.fillStyle='rgba(255,255,255,.04)'; roundRect(ctx, pad-6, y-6, width-2*(pad-6), h+12, 14, true, false);
    ctx.drawImage(img, x, y, w, h);
    // parodome iki 3 spalvÅ³ paletÄ—s taÅ¡kus
    const dots = it.palette.slice(0,3);
    let dx = width-18 - dots.length*16;
    dots.forEach(p=>{ ctx.fillStyle=p.hex; roundRect(ctx, dx, y-6, 14, 14, 4, true, false); dx += 16; });
    y += boxH + pad;
  }
}
function renderOutfits(list){
  const root=$('#outfits'); root.innerHTML='';
  list.forEach((o,i)=>{
    const card=document.createElement('div'); card.className='outfit';
    const cvswrap=document.createElement('div'); cvswrap.className='canvaswrap';
    const canvas=document.createElement('canvas'); cvswrap.appendChild(canvas);
    const row=document.createElement('div'); row.className='row';
    const info=document.createElement('div'); info.innerHTML=`<div class="muted">Score: ${o.score.toFixed(2)}</div>`;
    const dl=document.createElement('a'); dl.textContent='â¬‡ï¸ AtsisiÅ³sti PNG'; dl.download=`outfit_${i+1}.png`; dl.href='#'; dl.className='chip'; dl.style.textAlign='center'; dl.style.textDecoration='none';
    row.appendChild(info); row.appendChild(dl);
    card.appendChild(cvswrap); card.appendChild(row);
    document.getElementById('outfits').appendChild(card);
    renderOutfitToCanvas(o, canvas).then(()=>{ dl.href = canvas.toDataURL('image/png'); });
  })
}

// Export / Import / Clear
function exportWardrobe(){ const blob = new Blob([JSON.stringify(wardrobe, null, 2)], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = "spinta.json"; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 1000); }
async function importWardrobe(file){ const txt = await file.text(); try{ const arr = JSON.parse(txt); if(Array.isArray(arr)){ wardrobe = arr; saveWardrobe(); renderWardrobe(); alert("Spinta Ä¯kelta âœ”ï¸"); } else { alert("Netinkamas failas"); } }catch(e){ alert("Nepavyko perskaityti failo"); } }
function clearWardrobe(){ if(confirm("IÅ¡valyti visÄ… spintÄ…?")){ wardrobe = []; saveWardrobe(); renderWardrobe(); } }

// Events
document.getElementById('addBtn').addEventListener('click', async ()=>{
  const f=document.getElementById('file').files[0]; if(!f){alert('Pasirink nuotraukÄ…'); return}
  const cat=document.getElementById('cat').value; const style=document.getElementById('style').value; const note=document.getElementById('note').value; const tag=document.getElementById('tag').value;
  const src=await fileToDataURL(f); addItem({src,cat,style,note,tag});
  document.getElementById('file').value=''; document.getElementById('note').value=''; document.getElementById('tag').value='';
})
document.getElementById('genBtn').addEventListener('click', ()=>{
  const n=parseInt(document.getElementById('count').value)||6; const b=parseInt(document.getElementById('boldness').value)||30;
  const outfits=generateOutfits(n,b); renderOutfits(outfits);
})
document.getElementById('clearOutfits').addEventListener('click', ()=>{document.getElementById('outfits').innerHTML='';})
document.getElementById('exportBtn').addEventListener('click', exportWardrobe);
document.getElementById('importFile').addEventListener('change', (e)=>{ const f=e.target.files[0]; if(f) importWardrobe(f); })
document.getElementById('clearWardrobe').addEventListener('click', clearWardrobe);

function fileToDataURL(file){return new Promise((res,rej)=>{const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file)})}

// Init
loadWardrobe(); renderWardrobe();
</script>
</body>
</html>
